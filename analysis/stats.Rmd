---
  title: "analysis"
date: "8/23/2019"
output: html_document
---
  
  ## Setup
  
```{r setup}
# Import libraries
library(tidyverse)
library(ggridges)
library(pwr) 
library(grid)
library(gtable)
library(boot)
library(bootES)
library(ggbeeswarm)
library(tidybayes)
library(cowplot)
library(broom)

# Set the plot themes
theme_set(theme_tidybayes() + panel_border() + background_grid())

# Import data
df <- read.csv("../results/pilot/CSV/TidyR.csv")
dfp <- read.csv("../results/pilot/CSV/participantInfoTidyR.csv")

# Clean the data for processing
df$value = as.numeric( as.character(df$value ))
df$userDriven = as.character(df$userDriven) 

taskType.labels <- c(cluster ="Cluster", "linear regression" = "Linear Regression", 'quadratic regression' = "Quadratic Regression", skyline = "Multivariate Optimization", outlier = "Outlier")

measure.labels <- c(accuracy ="Accuracy", "secondsOnTask" = "Time (seconds)", 'confidence' = "Confidence", difficulty = "Difficulty")

 df$taskType = taskType.labels[as.character(df$taskType)]
  df$measure = measure.labels[as.character(df$measure)]
  
 df$taskType_f = factor(df$taskType, levels=c("Cluster","Linear Regression", "Quadratic Regression","Multivariate Optimization", "Outlier"));
  df$measure_f = factor(df$measure, levels=c("Accuracy","Time (seconds)", "Confidence", "Difficulty"));



```

```{r}

userDriven.colors <- c('User Driven' ="#05b4dd", Supported = "#f4aa4a")
userDriven.labels <- c(manual ="User Driven", supported = "Supported")

df$userLabel = userDriven.labels[as.character(df$userDriven)]

df$custom_group <- ifelse(df$taskDifficulty=='easy', "easy", "medium_hard")

df_medium_hard = df %>%
  filter(custom_group=="medium_hard")%>%
filter(measure=="Accuracy")

df_easy = df %>%
  filter(custom_group=="easy")%>%
filter(measure=="Accuracy")

df_acc <- df %>% 
  filter(measure=="Accuracy")

df_acc$value = as.numeric( as.character(df_acc$value )) 

df_time <- df %>% 
  filter(measure=="secondsOnTask") 

df_time$value = as.numeric( as.character(df_time$value ))



```


```{r}
wtest <- function(data,type) {
t_manual = data %>% 
  filter(taskType == type & userDriven == "manual") %>%
  arrange(prolificId, taskId, dataset)

t_supported = data %>% 
  filter(taskType == type & userDriven == "supported")%>%
  arrange(prolificId, taskId, dataset)

# p = 0.06-- promising at the pilot level
print(type)
wilcox.test(t_manual$value, t_supported$value, paired=T)
}


wtest(df_medium_hard,"Cluster")
wtest(df_medium_hard,"Linear Regression")
wtest(df_medium_hard,"Outlier")
wtest(df_medium_hard,"Quadratic Regression")
wtest(df_medium_hard,"Multivariate Optimization")


# wtest(df_medium_hard,"Cluster")
# wtest(df_medium_hard,"Linear Regression")
# wtest(df_medium_hard,"Outlier")
# wtest(df_medium_hard,"Quadratic Regression")
# wtest(df_medium_hard,"Multivariate Optimization")
```


```{r}


reportES <- function(data, attr, group) {

  lvs <- levels(as.factor(data[[group]]))

  b <- bootES(data,
              data.col=attr,
              group.col=group,
              contrast=lvs, # normal cases c(group1=1, group2=-1), but for 2 groups, it's simplified.
              effect.type="cohens.d")

  cat( "d=", round( b$t0, 2), "~",
       "[", round( b$bounds[1], 2), ",",
       round( b$bounds[2], 2), "]",
       sep="")
}

estext <- function(type, measure_) {
  
df_tmp <- df %>% 
  filter(measure==measure_) 

# df_tmp$value = as.numeric( as.character(df_tmp$value ))

esd = df_tmp %>% 
  filter(taskType == type)

cat( paste(type, "\n") )
reportES(esd, "value", "userDriven")
cat( "\n" )
cat( "\n" )


}



estext("Cluster", "Accuracy")
estext("Linear Regression", "Accuracy")
estext("Outlier", "Accuracy")
estext("Quadratic Regression", "Accuracy")
estext("Multivariate Optimization", "Accuracy")
```



```{r fig.width=4, fig.height=4 }

gridLines <- function(x) { 
 if (max(as.numeric(x))<2) seq(0,1, .25) 
  else if (max(as.numeric(x))<10) seq(1, 5, 1) 
  else (c(0,100))
}
axisRange <- function(x) { 
  if (max(as.numeric(x))<2) c(0,1)
   else  if (max(as.numeric(x))<10) c(0,5)
  else (c(0,100))
}



 filteredData = df %>%
  filter(custom_group=="medium_hard")  %>%
filter(measure=="Accuracy")
  

  
g<- filteredData %>% 
  ggplot( aes(x=userLabel, y=value, fill = userLabel, color = userLabel) ) +
    facet_grid(taskType_f ~ .)+

    # geom_jitter( shape=16 , colour='grey', alpha=0.7, size=2, position = position_jitter(w = 0.3, h = 0)) +
    geom_violin(show.legend=FALSE) +

    stat_summary(fun.data = "mean_cl_boot", geom="linerange", size=1,alpha=1, colour = "#5c5c5c", show.legend=FALSE) +
    stat_summary(fun.data = "mean_cl_boot", colour = "#5c5c5c", size = 1, alpha=0.5, show.legend=FALSE) +
 
  # ylim(0,100) +
   # ylim(0,100) +
  coord_flip() +
      scale_color_manual(values=userDriven.colors)+
  scale_fill_manual(values=userDriven.colors)+
  theme(strip.text.y = element_text(angle = 0))+
    scale_y_continuous(breaks = gridLines, limits = axisRange) #,labels = gridLabels) 


stt <- ggplot_build(g)$data[[3]]

print (stt)

stt$PANEL <- as.numeric( as.character(stt$PANEL ))
stt$taskType <- ifelse((stt$PANEL <2), "Cluster", ifelse((stt$PANEL <3), "Linear Regression", ifelse((stt$PANEL <4), "Quadratic Regression", ifelse((stt$PANEL <5), "Multivariate Optimization", "Outlier"))))

stt$taskType_f = factor(stt$taskType, levels=c("Cluster","Linear Regression", "Quadratic Regression","Multivariate Optimization", "Outlier"));

stt$userLabel <- ifelse(stt$group=="2", 'User Driven', 'Supported')


print (stt)


g + geom_text(data = stt,
              aes(x =userLabel, y = 0, hjust = 0,label = paste(round(y,3) , '[' , round(ymin,3) ,  ',' , round(ymax,3) , ']',
                                                                sep=" ")),
             color = "#5c5c5c",size=4,
              vjust = 1)  +
   facet_grid(taskType_f ~ .)+
    scale_y_continuous(breaks = gridLines, limits = axisRange)+
  theme(
    panel.background = element_rect(fill = NA),
    panel.border = element_blank(),
    panel.ontop = TRUE,
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "white"),
    panel.spacing.y = unit(1, "lines"),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank()
  ) +

   labs(y="Accuracy", x = '')
# 
filename <- paste("accuracy_medium_hard.pdf")
 ggsave(filename, width = 6, height = 4, units = "in")
 

```




```{r fig.width=8, fig.height=4}

gridLines <- function(x) { 
 if (max(as.numeric(x))<2) c(0,1)
  else if (max(as.numeric(x))<10) seq(1, 5, 1) 
  else (c(0,100))
}


# 
# gridLabels <- function(x) { 
#   if (max(as.numeric(x)) < 1.1) seq(0, 1, .5) 
#   else if (max(as.numeric(x)) == 7.3) seq (1,7,2)
#     else seq(0, 5,1 )
#     #else seq(0, round(max(x)), round(max(x)/3)) 
# }



# df_acc$custom_group <- ifelse(df_acc$taskDifficulty=='easy', "easy", "medium_hard")
# df_time$custom_group <- ifelse(df_time$taskDifficulty=='easy', "easy", "medium_hard")
# 
# df_medium_hard = df_acc %>%
#   filter(custom_group=="medium_hard")  %>%
#    mutate( userLabel = userDriven.labels[as.character(userDriven)] )

# df_medium_hard = df_time

df_data =  df %>%
  filter(custom_group=="medium_hard")


  
g<- df_data %>% 
  ggplot( aes(x=userLabel, y=value, fill = userLabel, color = userLabel) ) +
    facet_grid(taskType_f ~ measure_f, scales="free")+

    # geom_jitter( shape=16 , colour='grey', alpha=0.7, size=2, position = position_jitter(w = 0.3, h = 0)) +
    geom_violin(show.legend=FALSE) +

    stat_summary(fun.data = "mean_cl_boot", geom="linerange", size=1,alpha=1, colour = "#5c5c5c", show.legend=FALSE) +
    stat_summary(fun.data = "mean_cl_boot", colour = "#5c5c5c", size = 1, alpha=0.5, show.legend=FALSE) +
 
  # ylim(0,100) +
   # ylim(0,100) +
  coord_flip() +
      scale_color_manual(values=userDriven.colors)+
  scale_fill_manual(values=userDriven.colors)+
  theme(strip.text.y = element_text(angle = 0))+
  scale_y_continuous(breaks = gridLines, limits = axisRange) #,labels = gridLabels) 

stt <- ggplot_build(g)$data[[3]]

print (stt)

stt$PANEL <- as.numeric( as.character(stt$PANEL ))
stt$taskType <- ifelse((stt$PANEL <5), "Cluster", ifelse((stt$PANEL <9), "Linear Regression", ifelse((stt$PANEL <13), "Quadratic Regression", ifelse((stt$PANEL <17), "Multivariate Optimization", "Outlier"))))

stt$taskType_f = factor(stt$taskType, levels=c("Cluster","Linear Regression", "Quadratic Regression","Multivariate Optimization", "Outlier"));

stt$measure <- ifelse((stt$PANEL %% 4 == 1), "Accuracy", ifelse((stt$PANEL %% 4 == 2), "Time (seconds)", ifelse((stt$PANEL %% 4 == 3), "Confidence", "Difficulty")))
stt$measure_f = factor(stt$measure, levels=c("Accuracy","Time (seconds)", "Confidence", "Difficulty"));

stt$userLabel <- ifelse(stt$group=="2", 'User Driven', 'Supported')


print (stt)


g + geom_text(
  data = stt,
  aes(x =userLabel, y = 0, hjust = 0,label = paste(round(y,3) , '[' , round(ymin,3) ,  ',' , round(ymax,3) , ']',sep=" ")),
  color = "#5c5c5c",size=2,
  vjust = 1
  ) +
  facet_grid(taskType_f ~ measure_f,scales = "free") +
  theme(
    panel.background = element_rect(fill = NA),
    panel.border = element_blank(),
    panel.ontop = TRUE,
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "white"),
    panel.spacing.y = unit(1, "lines"),
    axis.line.y = element_blank(),
    axis.line.x = element_blank(),
    axis.ticks.y = element_blank()
  ) 
# 

filename <- paste("results_medium_hard.pdf")
 ggsave(filename, width = 10, height = 5, units = "in")


 
```


```{r fig.width=8, fig.height=12}

gridLines <- function(x) { 
 if (max(as.numeric(x))<2) c(0,1)
  else if (max(as.numeric(x))<10) seq(1, 5, 1) 
  else (c(0,100))
}

axisRange <- function(x) { 
  if (max(as.numeric(x))<2) c(0,1)
   else  if (max(as.numeric(x))<10) c(0,5)
  else (c(0,100))
}

df_data = df
  
# df_data %>% 
#   ggplot( aes(x=userLabel, y=value, fill = userLabel, color = userLabel) ) +
#     facet_grid(taskId ~ measure_f, scales="free")+
# 
#     # geom_jitter( shape=16 , colour='grey', alpha=0.7, size=2, position = position_jitter(w = 0.3, h = 0)) +
#     geom_violin(show.legend=FALSE) +
# 
#     stat_summary(fun.data = "mean_cl_boot", geom="linerange", size=1,alpha=1, colour = "#5c5c5c", show.legend=FALSE) +
#     stat_summary(fun.data = "mean_cl_boot", colour = "#5c5c5c", size = 1, alpha=0.5, show.legend=FALSE) +
#  
#   # ylim(0,100) +
#    # ylim(0,100) +
#   coord_flip() +
#       scale_color_manual(values=userDriven.colors)+
#   scale_fill_manual(values=userDriven.colors)+
#   theme(strip.text.y = element_text(angle = 0))+
#   scale_y_continuous(breaks = gridLines, limits = axisRange) #,labels = gridLabels) 
#  
# filename <- paste("results_allTasks.pdf")
#  ggsave(filename, width = 10, height = 20, units = "in")


 
```


```{r  fig.width=7, fig.height=8}

dfp_filtered = dfp %>% 
  filter(type=="feedback");


dfp_filtered$value = as.numeric( as.character(dfp_filtered$value ))
 
 # dfp_filtered%>% 
 #  ggplot( aes(x=0, y=value) ) +
 #    geom_jitter( shape=1 , color="grey", position = position_jitter(w = 0.1, h = 0)) +
 #       geom_violin(show.legend=FALSE,alpha=0.5) +
 # 
 #    stat_summary(fun.data = "mean_cl_boot", colour = "red", size = 0.5, alpha=0.5) +
 #  # ylim(0,100) +
 #   # xlim(-.25,.25) +
 #  coord_flip() +
 #    facet_grid(measure ~ .)+
 #  theme(strip.text.y = element_text(angle=0))

# Feedback histogram point and line data
mean_cl_boot_data <- dfp_filtered %>%
  group_by(measure) %>%
  do(data.frame(rbind(Hmisc::smean.cl.boot(.$value))))
 
# Feedback histogram
ggplot(dfp_filtered) +
  geom_histogram(aes(x = value), binwidth = 1, boundary = 0.5) +
  geom_point(
    data = mean_cl_boot_data,
    aes(x = Mean, y = -50),
    colour = "#5c5c5c"
  ) +
  geom_line(
    data = reshape2::melt(mean_cl_boot_data),
    aes(x = value, y = -50)
  ) + 
  facet_grid(measure ~ .)+
  theme(strip.text.y = element_text(angle=0)) +
  scale_y_continuous(limits = c(-100, 100))+
    scale_y_continuous(limits = c(-100,100))+
    theme(
    panel.background = element_rect(fill = NA),
    panel.border = element_blank(),
    panel.ontop = TRUE,
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "white"),
    panel.spacing.y = unit(1, "lines"),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank()
  ) 



```

```{r fig.width=10, fig.height=8}

# Confidence and difficulty histogram point and line data
mean_cl_boot_conf_diff <- df %>%
  filter(measure=="Confidence" | measure=="Difficulty") %>%
  group_by(measure_f, userDriven, taskType_f) %>%
  do(data.frame(rbind(Hmisc::smean.cl.boot(.$value))))

df_data_conf_diff<- df %>%
  filter(measure=="Confidence" | measure=="Difficulty")

reshape2::melt(mean_cl_boot_conf_diff)

# Confidence and difficulty histograms
ggplot(df_data_conf_diff, aes(x=value) ) +
  geom_histogram(aes(y=..density..), binwidth = 1, boundary = 0.5) + 
  geom_point(
    data = mean_cl_boot_conf_diff,
    aes(x = Mean, y = -0.25),
    colour = "#5c5c5c"
  ) +
  geom_line(
    data = reshape2::melt(mean_cl_boot_conf_diff),
    aes(x = value, y = -0.25),
    color = "blue"
  ) +
  geom_text(
    data = mean_cl_boot_conf_diff,
    aes(label = , y = -0.25),
    colour = "#5c5c5c"
  ) +
  facet_grid(taskType_f + userDriven ~ measure_f, scales="free") +
  theme(strip.text.y = element_text(angle = 0)) +
  scale_y_continuous(limits = c(-0.5,0.75))+
    theme(
    panel.background = element_rect(fill = NA),
    panel.border = element_blank(),
    panel.ontop = TRUE,
    panel.grid.major.y = element_blank(),
    panel.grid.major.x = element_line(color = "white"),
    panel.spacing.y = unit(1, "lines"),
    axis.line.y = element_blank(),
    axis.ticks.y = element_blank()
  ) 
```




